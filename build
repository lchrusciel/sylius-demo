#!/bin/sh

set -e
set -x

# Create a sylius project. We can consider using -s dev flag to download a dev master Sylius version instead of the latest tagged one.
composer -n create-project sylius/sylius
mv -f sylius/* .
rm -R sylius
find {app,web} -type d -print0 | xargs -0 chmod -R 777

cp app/config/parameters.yml.dist app/config/parameters_sylius.yml

# Setup project parameters
sed -i "s/database_host: 127.0.0.1/database_host: ${SYMFONY__DATABASE_SERVER}/g" app/config/parameters_sylius.yml
sed -i "s/database_name: sylius/database_name: ${SYMFONY__DATABASE_NAME}/g" app/config/parameters_sylius.yml
sed -i "s/database_user: root/database_user: ${SYMFONY__DATABASE_USER}/g" app/config/parameters_sylius.yml
sed -i "s/database_password: ~/database_password: ${SYMFONY__DATABASE_PASSWORD}/g" app/config/parameters_sylius.yml

sed -i "s/mailer_transport: smtp/mailer_transport: ${SYMFONY__MAILER_TRANSPORT}/g" app/config/parameters_sylius.yml
sed -i "s/mailer_host: 127.0.0.1/mailer_host: ${SYMFONY__MAILER_HOST}/g" app/config/parameters_sylius.yml
sed -i "s/mailer_user: null/mailer_user: ${SYMFONY__MAILER_USER}/g" app/config/parameters_sylius.yml
sed -i "s/mailer_password: null/mailer_password: ${SYMFONY__MAILER_PASSWORD}/g" app/config/parameters_sylius.yml

sed -i "s/currency: USD/currency: ${SYMFONY__CURRENCY}/g" app/config/parameters_sylius.yml

sed -i "s/resource: parameters.yml/resource: parameters_sylius.yml/g" app/config/config.yml
sed -i "/^imports:/ a\    - { resource: parameters.yml }\\" app/config/config.yml

# Delete a DB Schema to ensure if it is empty. With '--no-interaction' flag sylius will try to update a current schema, so it can cause an exception.
# If we don't care about demo database demo it will be just insurance that schema does not exist.
app/console doctrine:database:drop --env=${SYMFONY_ENV} --force

# Install Sylius
app/console sylius:install --env=${SYMFONY_ENV} --no-interaction

# Loads some demo data
app/console doctrine:fixtures:load --env=${SYMFONY_ENV} --no-interaction

# In addition to these folders, we should also ensure, that: assets, bundles, css, js and media folders inside a web folder will have a proper access rights
find {app/{cache,logs,config},web} -type d -print0 | xargs -0 chmod -R 777
find web/assets -type f -print0 | xargs -0 chmod -R 0776
